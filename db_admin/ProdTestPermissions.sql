-- Use this file to run an end to end test

------------------
-- Replace <USERNAME> with your current user
------------------

-- USE ROLE ACCOUNTADMIN;

-- GRANT ROLE ROLE_INGEST TO USER <USERNAME>;
-- GRANT ROLE ROLE_TRANSFORM TO USER <USERNAME>;
-- GRANT ROLE ROLE_REPORT TO USER <USERNAME>;


------------------
-- TEST LOAD
------------------
USE ROLE prod_db_raw_crwx_rl; 
USE WAREHOUSE WAREHOUSE_INGEST;
CREATE OR REPLACE SCHEMA prod_ctf_raw.SOURCE_NAME;

CREATE OR REPLACE TABLE prod_ctf_raw.SOURCE_NAME.MYTABLE (AMOUNT NUMBER);

INSERT INTO MYTABLE VALUES(1);

SELECT * FROM MYTABLE;


------------------
-- TEST TRANSFORM
------------------
USE ROLE prod_db_trf_rwx_rl; 
USE WAREHOUSE WAREHOUSE_TRANSFORM;
CREATE OR REPLACE SCHEMA prod_ctf_clean.BUSINESS;

CREATE OR REPLACE TABLE prod_ctf_clean.BUSINESS.MATERIALISED_TABLE AS (SELECT AMOUNT*2.5 AS SALES_AMOUNT FROM RAW.SOURCE_NAME.MYTABLE);
CREATE OR REPLACE VIEW prod_ctf_clean.BUSINESS.BUSINESS_VIEW AS (SELECT * FROM MATERIALISED_TABLE);

SELECT * FROM BUSINESS_VIEW;


------------------
-- TEST REPORT
------------------
USE ROLE prod_usr_ba_rl; 
USE WAREHOUSE WAREHOUSE_REPORT;
USE SCHEMA prod_usr_ba_rl.BUSINESS;

SELECT * FROM MATERIALISED_TABLE;
SELECT * FROM BUSINESS_VIEW;


