-- Use this file to run an end to end test

------------------
-- Replace <USERNAME> with your current user
------------------

-- USE ROLE ACCOUNTADMIN;

-- GRANT ROLE ROLE_INGEST TO USER <USERNAME>;
-- GRANT ROLE ROLE_TRANSFORM TO USER <USERNAME>;
-- GRANT ROLE ROLE_REPORT TO USER <USERNAME>;


------------------
-- TEST LOAD
------------------
-- By default, all DE users have the DE role which means we can do sandbox queries
-- USE ROLE prod_db_sndbx_rwx_rl; 
USE WAREHOUSE PROD_ADHOC_WH;
USE SCHEMA PROD_CTF_SANDBOX.USR_SANDBOX;

CREATE OR REPLACE TABLE PROD_CTF_SANDBOX.USR_SANDBOX.MYTABLE (AMOUNT NUMBER);

INSERT INTO MYTABLE VALUES(1);

SELECT * FROM MYTABLE;


------------------
-- TEST TRANSFORM
------------------
USE WAREHOUSE PROD_ADHOC_WH;
USE SCHEMA PROD_CTF_SANDBOX.USR_SANDBOX;

CREATE OR REPLACE TABLE PROD_CTF_SANDBOX.USR_SANDBOX.MATERIALISED_TABLE AS (SELECT AMOUNT*2.5 AS SALES_AMOUNT FROM PROD_CTF_SANDBOX.USR_SANDBOX.MYTABLE);
CREATE OR REPLACE VIEW PROD_CTF_SANDBOX.USR_SANDBOX.BUSINESS_VIEW AS (SELECT * FROM MATERIALISED_TABLE);

SELECT * FROM BUSINESS_VIEW;


------------------
-- TEST REPORT
------------------
USE WAREHOUSE PROD_ADHOC_WH;

SELECT * FROM MATERIALISED_TABLE;
SELECT * FROM BUSINESS_VIEW;

